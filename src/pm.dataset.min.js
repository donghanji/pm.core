/*
   pm.build.js ,version 1.2.1 ,updated on 2016-03-07
   module for Plugins Modules library.

   https://github.com/donghanji/pm
 */

!function(a){var b=module.globals("$");module.declare("pm.dataset",[b,"pm"],function(c,d){function e(b){var c=["[",o];return b!==a&&(c=c.concat(["=",'"',b,'"'])),c.push("]"),c.join("")}function f(a){var b=a.find(e()),c={};return b.each(function(){var a=j(this).attr(o);c[a]=e(a)}),c}function g(a){for(var b=0,c=a.length,d={};c>b;b++){var f=a[b];d[f]=e(f)}return d}function h(a){return"string"==typeof a&&(a=[a]),a=l.toBoolean(a)?a:l.extend(f(this.$el),this.fields),l.isArray(a)&&(a=g(a)),a||{}}function i(b,c){if(b&&b.length){var d=b[0].nodeName;if(d=d.toLowerCase(),"img"===d)return c!==a?b.attr("src",c):b.attr("src");var e=this.mappings[d];return e?c!==a?b[e](c):b[e]():c!==a?b.val(c):b.val()}}var j=c(b),k=c("pm"),l=k.utils,m=["get","set","save","handle","val","_delegateChanges"],n=["data","fields","defaults","settings","gettings"],o="data-field",p={label:"text",span:"text",p:"html",div:"html"},q=k.extend(Object,{constructor:function(a){var b=this;a=a||{},l.extend(b,l.omit(a,m));var c=a.el||"body",d=a.fields||{};l.isArray(d)&&(d=g(d)),b.$el=j(c),b.el=b.$el[0],l.each(n,function(c,d){b[c]=a[c]||{}}),b.fields=d,b.mappings=l.extend(p,a.mappings||{}),b.initialize.apply(b,arguments)},initialize:function(){},get:function(b){var c={},d=this.gettings["..."];b=h.call(this,b);for(var f in b){var g=this.fields[f]||b[f]||e(f),j=this.$el.find(g),k=this.gettings[f]||d,m=a;k&&l.isFunction(k)&&(m=k.call(this,j,f,b)),m=m!==a?m:i.call(this,j),m=m!==a?m:this.defaults[f],m!==a&&(c[f]=m)}return c},set:function(){var a=this._delegateChanges.apply(this,Array.prototype.slice.call(arguments,0)),b=l.result(this,"changes");if(!l.toBoolean(b))return this;if(a.length)for(var c=0,d=a.length;d>c;c++){var e=a[c],f=b[e],g=b["*"];l.isFunction(f)||(f=this[b[e]]),f&&(f=l.bind(f,this),f.call(this,this.data[e],e)),l.isFunction(g)||(g=this[b["*"]]),g&&(g=l.bind(g,this),g.call(this,this.data[e],e))}return this},save:function(){return this._delegateChanges.apply(this,Array.prototype.slice.call(arguments,0)),this},handle:function(a,b){return l.isString(a)&&(a=this.fields[a]||e(a),a=this.$el.find(a)),i.call(this,a,b)},val:function(a){var b=this.get(a);return l.isString(a)?b[a]:b},_delegateChanges:function(b,c){if(b=b||{},"string"==typeof b){var d={};d[b]=c,c=[b],b=d}if(!l.toBoolean(b))return[];c===a&&(c=l.keys(b)),c=h.call(this,c);var f=[],g=this.settings["..."];for(var j in b){var k=this.fields[j]||c[j]||e(j),m=this.$el.find(k),n=b[j],o=this.settings[j]||g;n=n!==a?n:this.defaults[j],o&&l.isFunction(o)?n=o.call(this,m,n,j,c):i.call(this,m,n),l.isEqual(n,this.data[j])||f.push(j),this.data[j]=n}return f}});return q.create=function(a){return new q(a)},q.DefaultOptions=m,k.ns("dataset"),k.dataset=q,q})}();